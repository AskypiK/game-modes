<manialink version="2" name="{( LayerName )}">
	<frame id="Frame_Main" hidden="1">
		<quad sizen="160 110" halign="center" valign="center" bgcolor="0007" image="{( BGImageUrl )}" posn="0 5 0"/>
		<label posn="0 45 1" text="{( WeaponChoiceTransText )}" halign="center" valign="center" style="TextTitle3" textsize="4"/>
		<label posn="0 40 1" text="{( NotEnoughGoldTransText )}" halign="center" valign="center" style="TextTitle3" textsize="1" textcolor="f00" hidden="1" id="Label_NotEnoughGold"/>
		<label id="Button_EndShop" posn="0 -50 1" text="{( ReadyTransText )}" halign="center" valign="center" style="CardButtonMediumS" scriptevents="1"/>
		
		<frame id="Frame_Rocket" posn="0 20 0">
			<frame id="FrameRocket1" posn="-50 0 1">
				<quad id="Quad_Rocket|1" image="{( ItemImageUrl )}" class="shopitem" scriptevents="1" bgcolor="0007" sizen="40 35" halign="center" valign="center" />
				<quad image="{( RocketImageUrl )}" posn="0 5 1" sizen="16 16" halign="center" valign="center" />
				<label text="{( AmmoTransText )}"  posn="-15 -4" style="TextTitle3" textsize="1" />
				<label text="{( ReloadTransText )}" posn="-15 -8" style="TextTitle3" textsize="1" />
				<label text="{( PriceTransText )}" posn="-15 -12" style="TextTitle3" textsize="1" />
				<label text="G." posn="16 -12" textcolor="fa0" halign="right" style="TextTitle3" textsize="1" />
				{( RocketLvl1Labels )}
			</frame>
			<frame id="FrameRocket2" posn="  0 0 1">
				<quad id="Quad_Rocket|2" image="{( ItemImageUrl )}" class="shopitem" scriptevents="1" bgcolor="0007" sizen="40 35" halign="center" valign="center" />
				<quad image="{( RocketImageUrl )}" posn="0 5 1" sizen="16 16" halign="center" valign="center" />
				<label text="{( AmmoTransText )}"  posn="-15 -4" style="TextTitle3" textsize="1" />
				<label text="{( ReloadTransText )}" posn="-15 -8" style="TextTitle3" textsize="1" />
				<label text="{( PriceTransText )}" posn="-15 -12" style="TextTitle3" textsize="1" />
				<label text="G." posn="16 -12" textcolor="fa0" halign="right" style="TextTitle3" textsize="1" />
				{( RocketLvl2Labels )}
			</frame>
			<frame id="FrameRocket3" posn=" 50 0 1">
				<quad id="Quad_Rocket|3" image="{( ItemImageUrl )}" class="shopitem" scriptevents="1" bgcolor="0007" sizen="40 35" halign="center" valign="center" />
				<quad image="{( RocketImageUrl )}" posn="0 5 1" sizen="16 16" halign="center" valign="center" />
				<label text="{( AmmoTransText )}"  posn="-15 -4" style="TextTitle3" textsize="1" />
				<label text="{( ReloadTransText )}" posn="-15 -8" style="TextTitle3" textsize="1" />
				<label text="{( PriceTransText )}" posn="-15 -12" style="TextTitle3" textsize="1" />
				<label text="G." posn="16 -12" textcolor="fa0" halign="right" style="TextTitle3" textsize="1" />
				{( RocketLvl3Labels )}
			</frame>
		</frame>
		<frame id="Frame_Nucleus" posn="0 -20 0">
			<frame id="FrameNucleus1" posn="-50 0 1">
				<quad id="Quad_Nucleus|1" image="{( ItemImageUrl )}" class="shopitem" scriptevents="1" bgcolor="0007" sizen="40 35" halign="center" valign="center" />
				<quad image="{( NucleusImageUrl )}" posn="0 5 1" sizen="16 16" halign="center" valign="center" />
				<label text="{( AmmoTransText )}"  posn="-15 -4" style="TextTitle3" textsize="1" />
				<label text="{( ReloadTransText )}" posn="-15 -8" style="TextTitle3" textsize="1" />
				<label text="{( PriceTransText )}" posn="-15 -12" style="TextTitle3" textsize="1" />
				<label text="G." posn="16 -12" textcolor="fa0" halign="right" style="TextTitle3" textsize="1" />
				{( NucleusLvl1Labels )}
			</frame>
			<frame id="FrameNucleus2" posn="0 0 1">
				<quad id="Quad_Nucleus|2" image="{( ItemImageUrl )}" class="shopitem" scriptevents="1" bgcolor="0007" sizen="40 35" halign="center" valign="center" />
				<quad image="{( NucleusImageUrl )}" posn="0 5 1" sizen="16 16" halign="center" valign="center" />
				<label text="{( AmmoTransText )}"  posn="-15 -4" style="TextTitle3" textsize="1" />
				<label text="{( ReloadTransText )}" posn="-15 -8" style="TextTitle3" textsize="1" />
				<label text="{( PriceTransText )}" posn="-15 -12" style="TextTitle3" textsize="1" />
				<label text="G." posn="16 -12" textcolor="fa0" halign="right" style="TextTitle3" textsize="1" />
				{( NucleusLvl2Labels )}
			</frame>
			<frame id="FrameNucleus3" posn="50 0 1">
				<quad id="Quad_Nucleus|3" image="{( ItemImageUrl )}" class="shopitem" scriptevents="1" bgcolor="0007" sizen="40 35" halign="center" valign="center" />
				<quad image="{( NucleusImageUrl )}" posn="0 5 1" sizen="16 16" halign="center" valign="center" />
				<label text="{( AmmoTransText )}"  posn="-15 -4" style="TextTitle3" textsize="1" />
				<label text="{( ReloadTransText )}" posn="-15 -8" style="TextTitle3" textsize="1" />
				<label text="{( PriceTransText )}" posn="-15 -12" style="TextTitle3" textsize="1" />
				<label text="G." posn="16 -12" textcolor="fa0" halign="right" style="TextTitle3" textsize="1" />
				{( NucleusLvl3Labels )}
			</frame>
		</frame>
		<frame id="Frame_Laser" posn="0 -20 0">
			<frame id="FrameLaser1" posn="-50 0 1">
				<quad id="Quad_Laser|1" image="{( ItemImageUrl )}" class="shopitem" scriptevents="1" bgcolor="0007" sizen="40 35" halign="center" valign="center" />
				<quad image="{( LaserImageUrl )}" posn="0 5 1" sizen="16 16" halign="center" valign="center" />
				<label text="{( AmmoTransText )}"  posn="-15 -4" style="TextTitle3" textsize="1" />
				<label text="{( ReloadTransText )}" posn="-15 -8" style="TextTitle3" textsize="1" />
				<label text="{( PriceTransText )}" posn="-15 -12" style="TextTitle3" textsize="1" />
				<label text="G." posn="16 -12" textcolor="fa0" halign="right" style="TextTitle3" textsize="1" />
				{( LaserLvl1Labels )}
			</frame>
			<frame id="FrameLaser2" posn="0 0 1">
				<quad id="Quad_Laser|2" image="{( ItemImageUrl )}" class="shopitem" scriptevents="1" bgcolor="0007" sizen="40 35" halign="center" valign="center" />
				<quad image="{( LaserImageUrl )}" posn="0 5 1" sizen="16 16" halign="center" valign="center" />
				<label text="{( AmmoTransText )}"  posn="-15 -4" style="TextTitle3" textsize="1" />
				<label text="{( ReloadTransText )}" posn="-15 -8" style="TextTitle3" textsize="1" />
				<label text="{( PriceTransText )}" posn="-15 -12" style="TextTitle3" textsize="1" />
				<label text="G." posn="16 -12" textcolor="fa0" halign="right" style="TextTitle3" textsize="1" />
				{( LaserLvl2Labels )}
			</frame>
			<frame id="FrameLaser3" posn="50 0 1">
				<quad id="Quad_Laser|3" image="{( ItemImageUrl )}" class="shopitem" scriptevents="1" bgcolor="0007" sizen="40 35" halign="center" valign="center" />
				<quad image="{( LaserImageUrl )}" posn="0 5 1" sizen="16 16" halign="center" valign="center" />
				<label text="{( AmmoTransText )}"  posn="-15 -4" style="TextTitle3" textsize="1" />
				<label text="{( ReloadTransText )}" posn="-15 -8" style="TextTitle3" textsize="1" />
				<label text="{( PriceTransText )}" posn="-15 -12" style="TextTitle3" textsize="1" />
				<label text="G." posn="16 -12" textcolor="fa0" halign="right" style="TextTitle3" textsize="1" />
				{( LaserLvl3Labels )}
			</frame>
		</frame>
	</frame>
	<script><!--
		#Include "TextLib" as TextLib

		#Const	WEAP_ROCKET		{( WEAP_ROCKET )}
		#Const	WEAP_NUCLEUS	{( WEAP_NUCLEUS )}
		#Const	WEAP_LASER		{( WEAP_LASER )}

		#Const	LVL_1			{( LVL_1 )}
		#Const	LVL_2			{( LVL_2 )}
		#Const	LVL_3			{( LVL_3 )}
	
		Void UpdateSelection() {
			declare netwrite Int3 Cli_Battle_P_ShopChoice for UI;
			
			declare CMlQuad[] ShopItemQuads;
			Page.GetClassChildren("shopitem", Page.MainFrame ,True);
			
			foreach(Item in Page.GetClassChildren_Result) {
				declare CMlQuad ItemQuad = (Item as CMlQuad);
				ShopItemQuads.add(ItemQuad);
			}
			
			// RESET
			foreach(ItemQuad in ShopItemQuads) {
				ItemQuad.RelativeScale = 1.;
				ItemQuad.Colorize = <0.1, 0.1, 0.1>;
			}
			
			declare Text QuadToColorize = "";
			switch(Cli_Battle_P_ShopChoice.X) {
				case WEAP_ROCKET : QuadToColorize = "Quad_Rocket|";
				case WEAP_NUCLEUS : QuadToColorize = "Quad_Nucleus|";
				case WEAP_LASER : QuadToColorize = "Quad_Laser|";
			}
			
			switch(Cli_Battle_P_ShopChoice.Y) {
				case LVL_1: QuadToColorize ^= "1";
				case LVL_2: QuadToColorize ^= "2";
				case LVL_3: QuadToColorize ^= "3";
			}
			
			declare CMlQuad MyQuad <=> (Page.GetFirstChild(QuadToColorize) as CMlQuad);
			if(MyQuad != Null) {
				MyQuad.RelativeScale = 1.;
				MyQuad.Colorize = <0.8, 1., 1.>;
			}
		}
		
		Integer GetCost(Integer _ShopWeapon, Integer _ShopLevel) {
			
			declare netread Integer[Integer][Integer] Srv_Battle_G_ShopCosts for Teams[0];
			
			if (Srv_Battle_G_ShopCosts.existskey(_ShopWeapon)) {
			
				declare Integer[Integer] WeaponCosts = Srv_Battle_G_ShopCosts[_ShopWeapon];
				
				if (WeaponCosts.existskey(_ShopLevel)) {	
					return WeaponCosts[_ShopLevel];
				}
			}
			
			return -1;
		}

		// ---------------------------------- //
		/**
		 * Gets the id of the given player.
		 *
		 * @param _Login The player's login to look for.
		 * @return The given player's id.
		 */
		Integer GetPlayerId(Text _Login) {
			declare netread Text[Integer] Srv_Player_G_Players for Teams[0];
			if(Srv_Player_G_Players.exists(_Login)) {
				return Srv_Player_G_Players.keyof(_Login);
			}
			
			return -1;
		}

		// ---------------------------------- //
		/**
		 * Get the local player's id.
		 *
		 * @return The local player's id.
		 */
		Integer GetInputPlayerId() {
			return GetPlayerId(InputPlayer.User.Login);
		}
		
		Integer GetInputPlayerGold() {
			declare netread Integer[Integer] Srv_Player_G_PlayersGold for Teams[0];
			return Srv_Player_G_PlayersGold[GetInputPlayerId()];
		}

		Boolean IsAttacker() {
			declare netread Boolean Srv_Battle_P_Clan for InputPlayer;
			return (Srv_Battle_P_Clan == True);
		}

		Void Init() {
			while(InputPlayer == Null) yield;
			while(InputPlayer.User == Null) yield;
		}
		
		main() {
			Init();
			
			declare netwrite Int3		Cli_Battle_P_ShopChoice		for UI;
			declare netwrite Boolean	Cli_Battle_P_ShopFinished	for UI;
			
			Cli_Battle_P_ShopChoice = <WEAP_ROCKET, LVL_1, 0>;
			Cli_Battle_P_ShopFinished = False;
			
			declare Integer LastShopWeapon = -1;
			declare Integer LastShopLevel  = -1;
			
			declare CMlFrame Frame_Main				<=> (Page.GetFirstChild("Frame_Main")			as CMlFrame); // TODO
			declare CMlFrame Frame_Nucleus 			<=> (Page.GetFirstChild("Frame_Nucleus")		as CMlFrame); // TODO
			declare CMlFrame Frame_Laser 			<=> (Page.GetFirstChild("Frame_Laser")			as CMlFrame); // TODO
			declare CMlLabel Label_NotEnoughGold	<=> (Page.GetFirstChild("Label_NotEnoughGold")	as CMlLabel); // TODO
			
			if(!IsSpectatorMode) {
				Frame_Main.Show();
			}

			if(GetInputPlayerId() < 0) {
				Frame_Main.Hide();
				Cli_Battle_P_ShopFinished = True;
			}
			
			while(True) {
				yield;
				
				{( Sync )}
				
				if (IsSpectatorMode) {
					Frame_Main.Hide();
					return;
				}
				
				Frame_Laser.Visible = IsAttacker();
				Frame_Nucleus.Visible = !Frame_Laser.Visible;
				
				foreach (Event in PendingEvents) {
					switch (Event.Type) {
						case CMlEvent::Type::MouseOver: {
							Event.Control.RelativeScale = 1.05;
							PlayUiSound(CMlScriptIngame::EUISound::Default, 0, 0.3);
						}
						case CMlEvent::Type::MouseOut: {
							Event.Control.RelativeScale = 1.0;
							Label_NotEnoughGold.Hide();
						}
						case CMlEvent::Type::MouseClick: {
							if(Event.ControlId == "Button_EndShop") {
								Cli_Battle_P_ShopFinished = True;
								Frame_Main.Hide();
								return;
							}
							
							declare Text[] CmdControl = TextLib::Split("|", Event.ControlId);
							if(CmdControl.count < 2) continue;
							
							declare Integer ShopWeapon	= -1;
							declare Integer ShopLevel	= -1;
							
							switch(CmdControl[0]) {
								case "Quad_Rocket": ShopWeapon = WEAP_ROCKET;
								case "Quad_Nucleus": ShopWeapon = WEAP_NUCLEUS;
								case "Quad_Laser": ShopWeapon = WEAP_LASER;
							}
							
							switch(CmdControl[1]) {
								case "1": ShopLevel = LVL_1;
								case "2": ShopLevel = LVL_2;
								case "3": ShopLevel = LVL_3;
							}
							
							declare Integer Cost = GetCost(ShopWeapon, ShopLevel);
							if (Cost >= 0) {
								if(GetInputPlayerGold() >= Cost) {
									Cli_Battle_P_ShopChoice = <ShopWeapon, ShopLevel, 0>;
								} else {
									Label_NotEnoughGold.Show();
								}
							}
						}
					}
				}
				
				if(LastShopWeapon != Cli_Battle_P_ShopChoice.X || LastShopLevel != Cli_Battle_P_ShopChoice.Y) {
					if(LastShopWeapon >= 0) PlayUiSound(CMlScriptIngame::EUISound::PlayerHit, 0, 1.0);
					
					LastShopWeapon = Cli_Battle_P_ShopChoice.X;
					LastShopLevel  = Cli_Battle_P_ShopChoice.Y;
					
					UpdateSelection();
				}
			}
		}
	--></script>
</manialink>